<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Título v1 restaurado -->
    <title>Generador de Nomenclatura</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Spinner de carga para el botón de registro */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        /* Estilo para campos deshabilitados */
        select:disabled, input:disabled {
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #9ca3af; /* text-gray-400 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-10">
    <div class="w-full max-w-2xl bg-white p-8 rounded-2xl shadow-xl mx-4">

        <!-- Encabezado (Restaurado a v1 como solicitó) -->
        <div class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-800">GENERADOR DE NOMENCLATURA</h1>
            <p class="text-xl text-gray-700 mt-2">Hospital de 2do. Nivel Isaías - Oruro (HIO)</p>
            <p class="text-sm text-gray-500 mt-1">Basado en el estándar ISO 19650</p>
        </div>

        <!-- Formulario Principal -->
        <form id="namingForm" onsubmit="return false;">
            <div class="space-y-5">
                
                <!-- 0. Clave de Acceso (v6: Sin número de paso) -->
                <div>
                    <label for="claveAcceso" class="block text-sm font-medium text-gray-700 mb-1">
                        Clave de Acceso Personal (Obligatorio)
                    </label>
                    <div class="flex gap-2">
                        <input type="password" id="claveAcceso" 
                               placeholder="Ingrese su clave y presione 'Validar'"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400">
                        <!-- (v6) Botón de Validación de Clave -->
                        <button type="button" id="validateKeyButton" 
                                class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Validar
                        </button>
                    </div>
                    <!-- (v6) Mensaje de estado de la clave -->
                    <p id="keyMessage" class="text-sm font-semibold mt-2 h-5"></p>
                </div>

                <!-- 1. Proyecto (Re-numerado) -->
                <div>
                    <label for="proyecto" class="block text-sm font-medium text-gray-700 mb-1">1. Proyecto</label>
                    <input type="text" id="proyecto" value="HIO" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none">
                </div>
                
                <!-- 2. Originador (Re-numerado) -->
                <div>
                    <label for="originador" class="block text-sm font-medium text-gray-700 mb-1">2. Originador (Obligatorio)</label>
                    <select id="originador" class="form-select w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                        <option value="" selected disabled>Seleccione un Originador...</option>
                        <option value="SUP">SUP - Supervisión (AA - Proes Marconi Souto)</option>
                        <option value="CON">CON - Contratista (EROBO)</option>
                        <option value="FIO">FIO - Fiscal de Obra (UPRE)</option>
                        <option value="FIS">FIS - Fiscal de Seguimiento (GAMO)</option>
                    </select>
                </div>

                <!-- 3. Disciplina (Re-numerado) -->
                <div>
                    <label for="disciplina" class="block text-sm font-medium text-gray-700 mb-1">3. Disciplina (Obligatorio)</label>
                    <select id="disciplina" class="form-select w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                        <option value="" selected disabled>Seleccione una Disciplina...</option>
                        <option value="GER">GER - Gerencia de Supervisión</option>
                        <option value="ARQ">ARQ - Arquitectura</option>
                        <option value="EST">EST - Estructuras</option>
                        <option value="ELT">ELT - Eléctrica</option>
                        <option value="HID">HID - Hidrosanitarias</option>
                        <option value="HVC">HVC - Climatización</option>
                        <option value="GMD">GMD - Gases Medicinales</option>
                        <option value="COM">COM - Datos y Comunicaciones</option>
                        <option value="BIO">BIO - Biomédico</option>
                        <option value="GNA">GNA - Gas Natural</option>
                        <option value="SSO">SSO - Seguridad y Salud Ocupacional</option>
                        <option value="MED">MED - Medio Ambiente</option>
                        <option value="GCC">GCC - Gestión / Coordinación / Control</option>
                    </select>
                </div>

                <!-- 4. Tipo de Documento (Re-numerado) -->
                <div>
                    <label for="tipo" class="block text-sm font-medium text-gray-700 mb-1">4. Tipo de Documento (Obligatorio)</label>
                    <select id="tipo" class="form-select w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                        <option value="" selected disabled>Seleccione un Tipo de Documento...</option>
                        <option value="M3D">M3D - Modelo 3D (rvt, ifc, nwd...)</option>
                        <option value="M2D">M2D - Plano 2D (dwg, pdf...)</option>
                        <option value="COM">COM - Cómputos Métricos (xls, pdf...)</option>
                        <option value="INF">INF - Informe (doc, pdf...)</option>
                        <option value="NOT">NOT - Nota (doc, pdf...)</option>
                        <option value="ACT">ACT - Acta (doc, pdf...)</option>
                        <option value="ESP">ESP - Especificación Técnica (doc, pdf...)</option>
                        <option value="MEM">MEM - Memoria de Cálculo (doc, pdf...)</option>
                        <option value="PRE">PRE - Presupuesto (xls, zpp...)</option>
                        <option value="CRN">CRN - Cronograma (mpp, pdf...)</option>
                        <option value="IMG">IMG - Imagen / Fotografía (png, pdf...)</option>
                    </select>
                </div>

                <!-- 5. Número Secuencial (Re-numerado) -->
                <div>
                    <label for="numero" class="block text-sm font-medium text-gray-700 mb-1">5. Número Secuencial (Obligatorio)</label>
                    <input type="number" id="numero" placeholder="Ej: 6" min="1"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" disabled>
                    <p class="mt-1 text-xs text-gray-500">
                        Es el ID único del archivo (ej. 0006). Consulte el Google Sheet para encontrar el siguiente número disponible.
                    </p>
                </div>

                <!-- 6. Revisión (Re-numerado) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">6. Revisión (Obligatorio)</label>
                    <div class="flex gap-4">
                        <select id="revisionTipo" class="form-select w-2/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                            <option value="" selected disabled>Seleccione un Tipo de Revisión...</option>
                            <option value="P">P - Versión Preliminar</option>
                            <option value="C">C - Versión para Construcción</option>
                            <option value="A">A - As-Built</option>
                        </select>
                        <input type="number" id="revisionNumero" placeholder="Ej: 1" min="1"
                               class="w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" disabled>
                    </div>
                </div>

                <!-- 7. Fecha (Re-numerado) -->
                <div>
                    <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">7. Fecha (Obligatorio)</label>
                    <input type="date" id="fecha"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                </div>
            </div>

            <!-- (v5) Sección de Metadatos -->
            <div class="border-t border-gray-200 mt-6 pt-5">
                <div>
                    <label for="subespecialidad" class="block text-sm font-medium text-gray-700 mb-1">
                        Subespecialidad (Opcional)
                    </label>
                    <input type="text" id="subespecialidad" 
                           placeholder="Ej: Iluminación, Puesta a Tierra, Cimentaciones..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" disabled>
                    <p class="mt-1 text-xs text-gray-500">
                        Detalle opcional para el registro. No forma parte del nombre del archivo.
                    </V>
                </div>
            </div>

            <!-- (v5) Área de Resultados -->
            <div class="border-t border-gray-200 mt-6 pt-5">
                
                <div>
                    <label for="resultado" class="block text-sm font-medium text-gray-700 mb-1">Vista Previa del Nombre de Archivo (ID)</label>
                    <input type="text" id="resultado" readonly
                           class="w-full px-3 py-3 bg-gray-100 text-gray-500 border border-gray-300 rounded-md focus:outline-none text-lg font-mono tracking-wide">
                    <p id="copyMessage" class="text-sm text-green-600 font-semibold mt-2 h-5 opacity-0 transition-opacity duration-300">¡Nombre copiado al portapapeles!</p>
                </div>
                
                <button type="button" id="copyButton"
                        class="w-full flex justify-center items-center gap-2 px-4 py-3 bg-gray-300 text-white font-semibold rounded-md shadow-md transition-all duration-200 ease-in-out cursor-not-allowed mt-4"
                        disabled>
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M7 2a2 2 0 00-2 2v12a2 2 0 002 2h6a2 2 0 002-2V4a2 2 0 00-2-2H7z"></path><path d="M10.5 1.5a1.5 1.5 0 00-3 0V3h3V1.5z"></path></svg>
                    Copiar Nombre de Archivo
                </button>
                
                <p class="text-xs text-gray-500 mt-4 mb-2">Paso final: Guarde este nombre en el registro centralizado.</p>
                
                <button type="button" id="registerButton"
                        class="w-full flex justify-center items-center gap-3 px-4 py-3 bg-orange-200 text-white font-bold rounded-md shadow-md transition-all duration-200 ease-in-out cursor-not-allowed"
                        disabled>
                    <div id="loadingSpinner" class="spinner w-5 h-5 border-4 border-t-4 border-white rounded-full hidden"></div>
                    <span id="registerButtonText">Registrar en Google Sheet</span>
                </button>
                
                <p id="registerMessage" class="text-sm text-center font-semibold mt-2 h-5"></p>

                <button type="button" id="clearButton"
                        class="w-full flex justify-center items-center gap-2 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-md shadow-sm transition-all duration-200 ease-in-out hover:bg-gray-300 mt-3">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    Limpiar Formulario
                </button>
            </div>

        </form>

        <!-- Pie de página -->
        <p class="text-center text-xs text-gray-400 mt-8">
            Herramienta desarrollada por Zacarias Ortega para el Proyecto Hospital de 2do. Nivel Isaías - Oruro.
        </p>

    </div>

    <!-- Lógica de la Aplicación -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONEXIÓN AL BACK-END ---
            const googleAppScriptURL = "https://script.google.com/macros/s/AKfycbxSjEUaROYSueif6pA4bJxnFlxdDF-21y9lG_qYu09J6KtK3WmWdS593plI6sgL_22X8w/exec";

            // --- REFERENCIAS A ELEMENTOS ---
            const form = document.getElementById('namingForm');

            // (v6) Separar campos bloqueados de campos de acción
            const keyInputs = {
                claveAcceso: document.getElementById('claveAcceso'),
                validateKeyButton: document.getElementById('validateKeyButton'),
                keyMessage: document.getElementById('keyMessage')
            };

            const formInputs = {
                originador: document.getElementById('originador'),
                disciplina: document.getElementById('disciplina'),
                tipo: document.getElementById('tipo'),
                numero: document.getElementById('numero'),
                revisionTipo: document.getElementById('revisionTipo'),
                revisionNumero: document.getElementById('revisionNumero'),
                fecha: document.getElementById('fecha'),
                subespecialidad: document.getElementById('subespecialidad'),
            };

            // Referencias a los campos de proyecto (siempre visibles)
            const proyectoInput = document.getElementById('proyecto');

            // Referencias a resultados y acciones
            const resultadoInput = document.getElementById('resultado');
            const copyButton = document.getElementById('copyButton');
            const copyMessage = document.getElementById('copyMessage');
            
            const registerButton = document.getElementById('registerButton');
            const registerButtonText = document.getElementById('registerButtonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const registerMessage = document.getElementById('registerMessage');
            const clearButton = document.getElementById('clearButton');
            

            // --- LÓGICA DE BLOQUEO (v6) ---
            
            /**
             * Bloquea o desbloquea todos los campos del formulario.
             * @param {boolean} lock - True para bloquear, False para desbloquear.
             */
            const lockForm = (lock) => {
                Object.values(formInputs).forEach(input => {
                    input.disabled = lock;
                });
                
                // Los botones de acción siempre deben estar deshabilitados al (re)bloquear
                if (lock) {
                    copyButton.disabled = true;
                    copyButton.classList.add('bg-gray-300', 'cursor-not-allowed');
                    copyButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                    
                    registerButton.disabled = true;
                    registerButton.classList.add('bg-orange-200', 'cursor-not-allowed');
                    registerButton.classList.remove('bg-[#ff9e3d]', 'hover:bg-[#e08c34]');
                }
            };
            
            /**
             * (v6) Valida la clave de acceso contra el Google Apps Script.
             */
            const validateKey = async () => {
                const claveValue = keyInputs.claveAcceso.value;
                if (!claveValue) {
                    keyInputs.keyMessage.innerText = "Debe ingresar una clave.";
                    keyInputs.keyMessage.className = "text-sm font-semibold mt-2 h-5 text-red-600";
                    return;
                }
                
                keyInputs.keyMessage.innerText = "Validando clave...";
                keyInputs.keyMessage.className = "text-sm font-semibold mt-2 h-5 text-gray-500";
                keyInputs.validateKeyButton.disabled = true;

                try {
                    // Usamos GET y pasamos la clave como parámetro de URL
                    const response = await fetch(`${googleAppScriptURL}?clave=${encodeURIComponent(claveValue)}`, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        // ¡ÉXITO!
                        keyInputs.keyMessage.innerText = result.message; // "Bienvenido, Zacarías Ortega."
                        keyInputs.keyMessage.className = "text-sm font-semibold mt-2 h-5 text-green-600";
                        keyInputs.claveAcceso.disabled = true; // Bloquear campo de clave
                        keyInputs.validateKeyButton.disabled = true; // Bloquear botón de validar
                        lockForm(false); // ¡Desbloquear el resto del formulario!
                        updateUI(); // Actualizar UI con campos vacíos
                        
                    } else {
                        // ERROR (Clave no válida)
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Error de validación:', error);
                    keyInputs.keyMessage.innerText = error.message || "Error al conectar. Intente de nuevo.";
                    keyInputs.keyMessage.className = "text-sm font-semibold mt-2 h-5 text-red-600";
                    keyInputs.validateKeyButton.disabled = false; // Permitir reintento
                    lockForm(true); // Asegurarse de que el formulario siga bloqueado
                }
            };
            
            keyInputs.validateKeyButton.addEventListener('click', validateKey);
            // Opcional: validar al presionar Enter en el campo de clave
            keyInputs.claveAcceso.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    validateKey();
                }
            });


            // --- LÓGICA PRINCIPAL ---
            
            // (v6) isFormValid ahora solo valida los campos de DATOS (la clave ya está validada)
            const isFormValid = () => {
                const numValid = formInputs.numero.value && parseInt(formInputs.numero.value, 10) > 0;
                const revNumValid = formInputs.revisionNumero.value && parseInt(formInputs.revisionNumero.value, 10) > 0;
                const fechaValid = formInputs.fecha.value !== "";
                const allSelected = formInputs.originador.value && formInputs.disciplina.value && formInputs.tipo.value && formInputs.revisionTipo.value;
                
                // La clave ya no se valida aquí, se asume válida si el form está desbloqueado
                return allSelected && numValid && fechaValid && revNumValid;
            };

            // (v6) updateUI ahora lee de 'formInputs' y 'proyectoInput'
            const updateUI = () => {
                const numValue = formInputs.numero.value;
                const numValid = numValue && parseInt(numValue, 10) > 0;

                const revNumValue = formInputs.revisionNumero.value;
                const revNumValid = revNumValue && parseInt(revNumValue, 10) > 0;

                const fechaValue = formInputs.fecha.value;
                const fechaFormateada = fechaValue ? fechaValue.replace(/-/g, '') : 'YYYYMMDD';

                const nombre = [
                    proyectoInput.value,
                    formInputs.originador.value || '???',
                    formInputs.disciplina.value || '???',
                    formInputs.tipo.value || '???',
                    (numValid ? String(numValue).padStart(4, '0') : '0000'),
                    (formInputs.revisionTipo.value || 'R?') + (revNumValid ? String(revNumValue).padStart(2, '0') : '??'),
                    fechaFormateada
                ].join('-'); 

                resultadoInput.value = nombre;
                
                const formIsValid = isFormValid();

                if (formIsValid) {
                    // Activar botón de Copiar
                    copyButton.disabled = false;
                    copyButton.classList.remove('bg-gray-300', 'cursor-not-allowed');
                    copyButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    
                    // Activar botón de Registrar
                    registerButton.disabled = false;
                    registerButton.classList.remove('bg-orange-200', 'cursor-not-allowed');
                    registerButton.classList.add('bg-[#ff9e3d]', 'hover:bg-[#e08c34]'); 

                    resultadoInput.classList.remove('text-gray-500', 'bg-gray-100');
                    resultadoInput.classList.add('text-black', 'bg-green-50');
                } else {
                    // Desactivar botones de acción (incluso si el formulario está desbloqueado)
                    copyButton.disabled = true;
                    copyButton.classList.add('bg-gray-300', 'cursor-not-allowed');
                    copyButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                    
                    registerButton.disabled = true;
                    registerButton.classList.add('bg-orange-200', 'cursor-not-allowed');
                    registerButton.classList.remove('bg-[#ff9e3d]', 'hover:bg-[#e08c34]'); 

                    resultadoInput.classList.add('text-gray-500', 'bg-gray-100');
                    resultadoInput.classList.remove('text-black', 'bg-green-50');
                }
            };

            // --- ACCIONES DE BOTONES ---

            // (v6) Lógica de COPIAR (sin cambios, pero ahora lee de 'formInputs')
            copyButton.addEventListener('click', () => {
                if (!isFormValid()) return;
                resultadoInput.select();
                resultadoInput.setSelectionRange(0, 99999);
                try {
                    document.execCommand('copy');
                    copyMessage.innerText = "¡Nombre copiado al portapapeles!";
                    copyMessage.classList.remove('opacity-0');
                    copyMessage.classList.add('opacity-100');
                    setTimeout(() => {
                        copyMessage.classList.remove('opacity-100');
                        copyMessage.classList.add('opacity-0');
                    }, 2000);
                } catch (err) {
                    console.error('Error al copiar: ', err);
                }
                window.getSelection().removeAllRanges();
            });

            // (v6) Lógica de REGISTRO (sin cambios, pero ahora lee de 'formInputs' y 'keyInputs')
            const registerData = async () => {
                if (!isFormValid()) {
                     alert("Por favor, complete todos los campos obligatorios antes de registrar.");
                    return;
                }

                registerButton.disabled = true;
                registerButtonText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                registerMessage.innerText = "Registrando...";
                registerMessage.className = "text-sm text-center font-semibold mt-2 h-5 text-gray-500";

                const nombreCompleto = resultadoInput.value;
                const revisionCompleta = (formInputs.revisionTipo.options[formInputs.revisionTipo.selectedIndex]?.text || "") + " " + String(formInputs.revisionNumero.value).padStart(2, '0');
                
                const payload = {
                    nombreCompleto: nombreCompleto,
                    proyecto: proyectoInput.value,
                    originador: formInputs.originador.options[formInputs.originador.selectedIndex]?.text || "",
                    disciplina: formInputs.disciplina.options[formInputs.disciplina.selectedIndex]?.text || "",
                    tipo: formInputs.tipo.options[formInputs.tipo.selectedIndex]?.text || "",
                    numero: String(formInputs.numero.value).padStart(4, '0'),
                    revision: revisionCompleta,
                    fecha: formInputs.fecha.value,
                    subespecialidad: formInputs.subespecialidad.value || "N/A",
                    claveAcceso: keyInputs.claveAcceso.value // La clave validada se envía para el registro
                };

                try {
                    const response = await fetch(googleAppScriptURL, {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        registerMessage.innerText = result.message; 
                        registerMessage.className = "text-sm text-center font-semibold mt-2 h-5 text-green-600";
                        
                        alert(result.message + ". El formulario se reiniciará.");
                        clearForm();

                    } else {
                        throw new Error(result.message);
                    }

                } catch (error) {
                    console.error('Error en el registro:', error);
                    registerMessage.innerText = `${error.message}`; 
                    registerMessage.className = "text-sm text-center font-semibold mt-2 h-5 text-red-600";
                    alert("Error al registrar: " + error.message);

                    registerButton.disabled = false;
                    registerButtonText.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                }
            };

            registerButton.addEventListener('click', registerData);

            // (v6) Lógica de LIMPIAR (actualizada para RE-BLOQUEAR)
            const clearForm = () => {
                form.reset(); // Limpia todos los campos
                
                // Re-bloquear el formulario
                lockForm(true); 
                
                // Desbloquear los campos de clave
                keyInputs.claveAcceso.disabled = false;
                keyInputs.validateKeyButton.disabled = false;
                keyInputs.keyMessage.innerText = "";
                keyInputs.keyMessage.className = "text-sm font-semibold mt-2 h-5";
                
                // Resetear mensajes
                copyMessage.innerText = "";
                copyMessage.classList.add('opacity-0');
                registerMessage.innerText = "";
                registerMessage.className = "text-sm text-center font-semibold mt-2 h-5";
                
                // Restaurar colores de 'select' y 'date' (aunque estén deshabilitados)
                Object.values(formInputs).forEach(input => {
                    if (input.tagName === 'SELECT' || input.type === 'date') {
                        input.style.color = '#6b7280';
                    }
                });

                // Actualizar UI (mostrará '???' y botones desactivados)
                updateUI();
            };

            clearButton.addEventListener('click', clearForm);

            // --- INICIALIZACIÓN ---
            
            // (v6) Asignar escuchadores solo a los campos de formulario
            Object.values(formInputs).forEach(input => {
                if (input.tagName === 'SELECT' || input.type === 'date') {
                    input.style.color = '#6b7280'; 
                    input.addEventListener('change', () => {
                        if(input.value) {
                            input.style.color = '#000000';
                        }
                    });
                }
                
                input.addEventListener('change', updateUI);
                if (input.type === 'number' || input.type === 'text') {
                    input.addEventListener('keyup', updateUI);
                }
            });

            // (v6) Estado inicial de la UI
            updateUI(); 
            // El formulario comienza bloqueado por defecto (definido en el HTML)
        });
    </script>
</body>
</html>
