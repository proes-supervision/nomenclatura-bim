<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Nomenclatura - HIO</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para navegadores que no soportan :invalid (como Safari en iOS < 16.4) */
        select:required:invalid {
            color: #6b7280; /* text-gray-500 */
        }
        /* Estilo para el placeholder del input de fecha */
        input[type="date"]:required:invalid::-webkit-datetime-edit {
            color: #6b7280;
        }
        /* Spinner de carga (oculto por defecto) */
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-full py-10 font-sans">

    <div class="w-full max-w-2xl mx-auto bg-white rounded-xl shadow-2xl p-8 md:p-10">

        <!-- Encabezado -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Registro de Nomenclatura</h1>
            <p class="text-lg text-gray-600 mt-1">Hospital de 2do. Nivel Isaías - Oruro (HIO)</p>
            <p class="text-sm text-gray-500 mt-2 border-l-4 border-blue-500 pl-3">Basado en el estándar ISO 19650.</p>
        </div>

        <!-- Formulario Principal -->
        <form id="namingForm" class="space-y-5">

            <!-- 1. Proyecto (Deshabilitado) -->
            <div>
                <label for="proyecto" class="block text-sm font-medium text-gray-700 mb-1">1. Proyecto</label>
                <input type="text" id="proyecto" value="HIO" readonly 
                       class="w-full px-3 py-2 bg-gray-200 text-gray-500 border border-gray-300 rounded-md focus:outline-none cursor-not-allowed">
            </div>

            <!-- Fila de Campos: 2. Originador y 3. Disciplina -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 2. Originador -->
                <div>
                    <label for="originador" class="block text-sm font-medium text-gray-700 mb-1">2. Originador</label>
                    <select id="originador" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 invalid:text-gray-400">
                        <option value="" disabled selected>Seleccione un Originador...</option>
                        <option value="CON">CON - Constructora EROBO</option>
                        <option value="SUP">SUP - Supervisión</option>
                        <option value="FIS">FIS - Fiscalización</option>
                    </select>
                </div>
                
                <!-- 3. Disciplina -->
                <div>
                    <label for="disciplina" class="block text-sm font-medium text-gray-700 mb-1">3. Disciplina</label>
                    <select id="disciplina" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 invalid:text-gray-400">
                        <option value="" disabled selected>Seleccione una Disciplina...</option>
                        <option value="GER">GER - Gerencia de Supervisión</option>
                        <option value="ARQ">ARQ - Arquitectura</option>
                        <option value="EST">EST - Estructuras</option>
                        <option value="CLM">CLM - Climatización (HVAC)</option>
                        <option value="ELT">ELT - Instalaciones Eléctricas</option>
                        <option value="HID">HID - Instalaciones Hidrosanitarias</option>
                        <option value="GMD">GMD - Gases Medicinales</option>
                        <option value="COM">COM - Datos y Comunicaciones</option>
                        <option value="BIO">BIO - Biomédico</option>
                        <option value="GNA">GNA - Gas Natural</option>
                        <option value="GCC">GCC - Gestión / Coordinación / Control</option>
                        <option value="SSO">SSO - Seguridad y Salud Ocupacional</option>
                        <option value="MED">MED - Medio Ambiente</option>
                    </select>
                </div>
            </div>

            <!-- Fila de Campos: 4. Tipo Documento y 5. Número -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 4. Tipo Documento -->
                <div>
                    <label for="tipo" class="block text-sm font-medium text-gray-700 mb-1">4. Tipo de Documento</label>
                    <select id="tipo" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 invalid:text-gray-400">
                        <option value="" disabled selected>Seleccione un Tipo...</option>
                        <option value="M3D">M3D - Modelo 3D (RVT, IFC...)</option>
                        <option value="M2D">M2D - Plano 2D (PDF, DWG...)</option>
                        <option value="INF">INF - Informe Técnico</option>
                        <option value="NOT">NOT - Nota (PDF, DOCX...)</option>
                        <option value="ESP">ESP - Especificación Técnica</option>
                        <option value="CAL">CAL - Memoria de Cálculo</option>
                        <option value="COM">COM - Cómputo Métrico</option>
                        <option value="PRE">PRE - Presupuesto</option>
                        <option value="CRO">CRO - Cronograma</option>
                        <option value="ACT">ACT - Acta / Minuta</option>
                        <option value="IMG">IMG - Imagen / Fotografía</option>
                    </select>
                </div>

                <!-- 5. Número -->
                <div>
                    <label for="numero" class="block text-sm font-medium text-gray-700 mb-1">5. Número Secuencial (Único)</label>
                    <input type="number" id="numero" required min="1" max="9999" placeholder="Ej: 0006"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400">
                    <p class="mt-1 text-xs text-gray-500">
                        p. ej: 0006. Número único para este documento. Consulte el Registro para asignar el siguiente.
                    </p>
                </div>
            </div>

            <!-- Fila de Campos: 6. Revisión y 7. Fecha -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 6. Revisión (Híbrido) -->
                <div>
                    <label for="revisionTipo" class="block text-sm font-medium text-gray-700 mb-1">6. Revisión (Tipo y Número)</label>
                    <div class="flex gap-2">
                        <select id="revisionTipo" required 
                                class="w-2/5 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 invalid:text-gray-400">
                            <option value="" disabled selected>Tipo...</option>
                            <option value="P">P - Preliminar</option>
                            <option value="C">C - Para Construcción</option>
                            <option value="A">A - As-Built</option>
                        </select>
                        <input type="number" id="revisionNumero" required min="1" max="99" placeholder="Nro (ej: 1)"
                               class="w-3/5 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400">
                    </div>
                </div>

                <!-- 7. Fecha -->
                <div>
                    <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">7. Fecha</label>
                    <input type="date" id="fecha" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-500">
                </div>
            </div>

            <!-- NUEVO CAMPO: Subespecialidad -->
             <div>
                <label for="subespecialidad" class="block text-sm font-medium text-gray-700 mb-1">
                    Subespecialidad (Opcional)
                </label>
                <input type="text" id="subespecialidad" 
                       placeholder="Ej: Iluminación, Puesta a Tierra, Cimentaciones..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400">
                <p class="mt-1 text-xs text-gray-500">
                    Detalle opcional para el registro. No forma parte del nombre del archivo.
                </p>
            </div>

            <!-- Separador -->
            <div class="pt-2">
                <hr class="border-gray-200">
            </div>

            <!-- SECCIÓN 1: RESULTADO (ID DE ARCHIVO) -->
            <div>
                <label for="resultado" class="block text-sm font-medium text-gray-700 mb-1">ID de Contenedor Único (Nombre de Archivo)</label>
                <input type="text" id="resultado" readonly
                       class="w-full px-3 py-3 bg-gray-200 text-gray-600 border border-gray-300 rounded-md focus:outline-none font-mono text-lg cursor-not-allowed">
                <!-- Mensaje de copiado -->
                <p id="copyMessage" class="text-sm text-green-600 font-semibold mt-2 opacity-0 transition-opacity duration-300">
                    ¡Nombre copiado al portapapeles!
                </p>
            </div>

            <!-- Botón de Copiar Nombre (ID) -->
            <button type="button" id="copyButton"
                    class="w-full flex justify-center items-center gap-2 px-4 py-3 bg-indigo-300 text-white font-semibold rounded-md shadow-md transition-all duration-200 ease-in-out cursor-not-allowed"
                    disabled>
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M7 2a2 2 0 00-2 2v12a2 2 0 002 2h6a2 2 0 002-2V4a2 2 0 00-2-2H7z"></path><path d="M10.5 1.5a1.5 1.5 0 00-3 0V3h3V1.5z"></path></svg>
                Copiar Nombre de Archivo
            </button>
        
            <!-- SECCIÓN 2: REGISTRO EN GOOGLE SHEETS (¡NUEVO!) -->
            <div class="pt-5 mt-5 border-t border-gray-200">
                <label class="block text-lg font-semibold text-gray-700 mb-2">
                    Registro Centralizado
                </label>
                <p class="text-sm text-gray-500 mb-3">
                    Tras copiar el nombre, regístrelo en la base de datos central de Google Sheets.
                </p>
                
                <button type="button" id="registerButton"
                        class="w-full flex justify-center items-center gap-3 px-4 py-3 bg-teal-300 text-white font-bold rounded-md shadow-md transition-all duration-200 ease-in-out cursor-not-allowed"
                        disabled>
                    <!-- Spinner de carga, oculto por defecto -->
                    <div id="loadingSpinner" class="spinner w-5 h-5 border-4 border-t-4 border-white rounded-full hidden"></div>
                    <span id="registerButtonText">Registrar en Google Sheet</span>
                </button>
                
                <!-- Mensaje de estado del registro -->
                <p id="registerMessage" class="text-sm text-center font-semibold mt-2 h-5"></p>
            </div>

        </form>

        <!-- Pie de página -->
        <p class="text-center text-xs text-gray-400 mt-6">
            Herramienta desarrollada por Zacarias Ortega para el Proyecto Hospital de 2do. Nivel Isaías - Oruro.
        </p>
    </div>

    <!-- Lógica de la aplicación -->
    <script>
        // ¡NO OLVIDE PEGAR SU URL AQUÍ!
        // Siga la "guia_paso_a_paso.md" (Parte 3, Paso 13) para obtener esta URL.
        const googleAppScriptURL = "https://script.google.com/macros/s/AKfycbxSjEUaROYSueif6pA4bJxnFlxdDF-21y9lG_qYu09J6KtK3WmWdS593plI6sgL_22X8w/exec";

        document.addEventListener('DOMContentLoaded', () => {
            // Referencias a todos los elementos interactivos
            const inputs = {
                proyecto: document.getElementById('proyecto'),
                originador: document.getElementById('originador'),
                disciplina: document.getElementById('disciplina'),
                tipo: document.getElementById('tipo'),
                numero: document.getElementById('numero'),
                revisionTipo: document.getElementById('revisionTipo'),
                revisionNumero: document.getElementById('revisionNumero'),
                fecha: document.getElementById('fecha'),
                subespecialidad: document.getElementById('subespecialidad') // ¡NUEVO CAMPO!
            };

            const resultadoInput = document.getElementById('resultado');
            const copyButton = document.getElementById('copyButton');
            const copyMessage = document.getElementById('copyMessage');
            
            // Nuevos elementos de Registro
            const registerButton = document.getElementById('registerButton');
            const registerButtonText = document.getElementById('registerButtonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const registerMessage = document.getElementById('registerMessage');


            // --- LÓGICA PRINCIPAL ---
            
            // Función auxiliar para obtener el TEXTO de un <select>
            const getSelectedText = (el) => {
                if (!el || el.selectedIndex === -1 || el.selectedIndex === 0) {
                    return null; 
                }
                return el.options[el.selectedIndex].text;
            };

            // Función para validar si el formulario está completo
            const isFormValid = () => {
                // Validar todos los 'select'
                const allSelected = [inputs.originador, inputs.disciplina, inputs.tipo, inputs.revisionTipo]
                    .every(el => el.value);
                
                const numValue = inputs.numero.value;
                const numValid = numValue && parseInt(numValue, 10) > 0;

                const revNumValue = inputs.revisionNumero.value;
                const revNumValid = revNumValue && parseInt(revNumValue, 10) > 0;

                const fechaValid = !!inputs.fecha.value; // Asegura que la fecha no esté vacía

                return allSelected && numValid && fechaValid && revNumValid;
            };

            // Función para formatear el nombre de archivo (con vista previa)
            const getGeneratedName = () => {
                const numValue = inputs.numero.value;
                const numValid = numValue && parseInt(numValue, 10) > 0;
                
                const revNumValue = inputs.revisionNumero.value;
                const revNumValid = revNumValue && parseInt(revNumValue, 10) > 0;

                const fechaValue = inputs.fecha.value;
                const fechaFormateada = fechaValue ? fechaValue.replace(/-/g, '') : 'YYYYMMDD';
                
                const revisionFormateada = (inputs.revisionTipo.value || 'R?') + (revNumValid ? String(revNumValue).padStart(2, '0') : '??');

                // 1. Construir el nombre con marcadores de posición
                const nombre = [
                    inputs.proyecto.value,
                    inputs.originador.value || '???',
                    inputs.disciplina.value || '???',
                    inputs.tipo.value || '???',
                    (numValid ? String(numValue).padStart(4, '0') : '0000'),
                    revisionFormateada,
                    fechaFormateada
                ].join('-'); 

                return { nombre, numValid, revNumValid, fechaFormateada, revisionFormateada };
            };

            // Función para actualizar la UI (se llama con cada input)
            const updateUI = () => {
                const { nombre } = getGeneratedName();
                
                resultadoInput.value = nombre;
                const formIsValid = isFormValid();

                // 3. Comprobar validez para cambiar estilos de botones
                if (formIsValid) {
                    // Activar botón de Copiar
                    copyButton.disabled = false;
                    copyButton.classList.remove('bg-indigo-300', 'cursor-not-allowed');
                    copyButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    
                    // Activar botón de Registrar
                    registerButton.disabled = false;
                    registerButton.classList.remove('bg-teal-300', 'cursor-not-allowed');
                    registerButton.classList.add('bg-teal-600', 'hover:bg-teal-700');

                    // Resaltar resultado
                    resultadoInput.classList.remove('text-gray-600', 'bg-gray-200', 'cursor-not-allowed');
                    resultadoInput.classList.add('text-gray-900', 'bg-blue-50');
                } else {
                    // Desactivar botón de Copiar
                    copyButton.disabled = true;
                    copyButton.classList.add('bg-indigo-300', 'cursor-not-allowed');
                    copyButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    
                    // Desactivar botón de Registrar
                    registerButton.disabled = true;
                    registerButton.classList.add('bg-teal-300', 'cursor-not-allowed');
                    registerButton.classList.remove('bg-teal-600', 'hover:bg-teal-700');

                    // Apagar resultado
                    resultadoInput.classList.add('text-gray-600', 'bg-gray-200', 'cursor-not-allowed');
                    resultadoInput.classList.remove('text-gray-900', 'bg-blue-50');
                }
            };

            // --- MANEJADORES DE EVENTOS ---

            // 1. Escuchadores de eventos para actualizar en tiempo real
            Object.values(inputs).forEach(input => {
                input.addEventListener('input', updateUI);
                input.addEventListener('change', updateUI);
            });

            // 2. Lógica de copiado para el Nombre (ID)
            copyButton.addEventListener('click', () => {
                if (!isFormValid()) return;
                
                resultadoInput.select();
                resultadoInput.setSelectionRange(0, 99999);
                
                try {
                    document.execCommand('copy');
                    copyMessage.innerText = "¡Nombre copiado al portapapeles!";
                    copyMessage.classList.remove('opacity-0', 'text-red-600');
                    copyMessage.classList.add('opacity-100', 'text-green-600');
                    setTimeout(() => {
                        copyMessage.classList.remove('opacity-100');
                        copyMessage.classList.add('opacity-0');
                    }, 2000);

                } catch (err) {
                    console.error('Error al copiar el nombre: ', err);
                }
                window.getSelection().removeAllRanges();
            });

            // 3. Lógica de REGISTRO en Google Sheets (¡NUEVO!)
            registerButton.addEventListener('click', async (e) => {
                e.preventDefault(); // Prevenir que el formulario se envíe
                
                if (!isFormValid()) {
                    registerMessage.innerText = "Complete todos los campos primero.";
                    registerMessage.className = "text-sm text-center font-semibold mt-2 h-5 text-red-600";
                    return;
                }

                if (googleAppScriptURL === "AQUÍ_PEGAS_LA_URL_DE_APPS_SCRIPT") {
                    alert("Error de configuración: La URL de Google Apps Script no ha sido configurada en el archivo index.html.");
                    return;
                }

                // Mostrar estado de carga
                registerButtonText.innerText = "Registrando...";
                loadingSpinner.classList.remove('hidden');
                registerButton.disabled = true;
                registerMessage.innerText = "";

                // Obtener los datos del formulario
                const { nombre, fechaFormateada, revisionFormateada } = getGeneratedName();
                
                const formData = {
                    nombreCompleto: nombre,
                    proyecto: inputs.proyecto.value,
                    originador: inputs.originador.value,
                    disciplina: inputs.disciplina.value,
                    tipo: inputs.tipo.value,
                    numero: String(inputs.numero.value).padStart(4, '0'),
                    revision: revisionFormateada,
                    fecha: fechaFormateada,
                    subespecialidad: inputs.subespecialidad.value || "" // Enviar vacío si no se llena
                };

                // Enviar los datos al Google Apps Script
                try {
                    const response = await fetch(googleAppScriptURL, {
                        method: 'POST',
                        mode: 'cors', // Necesario para peticiones cross-origin
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8', // Apps Script a menudo prefiere text/plain
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        registerMessage.innerText = "¡Registrado con éxito!";
                        registerMessage.className = "text-sm text-center font-semibold mt-2 h-5 text-green-600";
                    } else {
                        throw new Error(result.message);
                    }

                } catch (error) {
                    console.error('Error al registrar en Google Sheet:', error);
                    registerMessage.innerText = "Error al registrar. Revise la consola.";
                    registerMessage.className = "text-sm text-center font-semibold mt-2 h-5 text-red-600";
                } finally {
                    // Ocultar estado de carga
                    registerButtonText.innerText = "Registrar en Google Sheet";
                    loadingSpinner.classList.add('hidden');
                    registerButton.disabled = false;
                }
            });


            // 4. Cambiar color del 'select' y 'date' al elegir una opción
             Object.values(inputs).forEach(input => {
                if (input.tagName === 'SELECT' || input.type === 'date') {
                    input.addEventListener('change', (e) => {
                        if (e.target.value) {
                            e.target.style.color = '#111827'; // gris-900
                        } else {
                             e.target.style.color = '#6b7280'; // gris-500
                        }
                    });
                }
            });

            // 5. Generar el estado inicial al cargar la página
            updateUI();
        });
    </script>
</body>
</html>



