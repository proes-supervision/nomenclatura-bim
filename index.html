<!--
v22 - SOLUCIÓN "FIRE AND FORGET"
* ARREGLO: Se modifica la función 'registerData' (Registro).
* YA NO usa 'await' ni 'try/catch' para esperar la respuesta del script.
* La aplicación "dispara" el registro y ASUME que funcionó.
* Después de 2 segundos, limpia el formulario.
* ESTO SOLUCIONA EL "CUELGUE", que era causado por el navegador
  bloqueando la respuesta del script (que no tenía header CORS).
*
* ESTE ARCHIVO ES COMPATIBLE CON EL SCRIPT v18 QUE USTED YA TIENE.
* NO TOQUE SU GOOGLE APPS SCRIPT.
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Nomenclatura HIO (v22)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos (spinner, disabled, etc.) */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        /* Estilo para campos deshabilitados */
        .form-field:disabled {
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #9ca3af; /* text-gray-400 */
            cursor: not-allowed;
            border-color: #d1d5db; /* border-gray-300 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-10">
    <div class="w-full max-w-2xl bg-white p-6 sm:p-8 rounded-2xl shadow-xl mx-4">

        <!-- Encabezado (v15) -->
        <div class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-800">Generador de Nomenclatura</h1>
            <p class="text-xl text-gray-700 mt-1">Hospital de 2do. Nivel Isaias</p>
            <p class="text-sm text-gray-500 mt-2">Basado en el estándar ISO 19650</p>
        </div>

        <!-- Formulario Principal -->
        <form id="namingForm" onsubmit="return false;">
            <div classs="space-y-4">

                <!-- 0. Clave de Acceso (v15) -->
                <div>
                    <label for="claveAcceso" class="block text-sm font-medium text-gray-700 mb-1">
                        Clave de Acceso Personal (Obligatorio)
                    </label>
                    <div class="flex gap-2">
                        <input type="password" id="claveAcceso" 
                               placeholder="Ingrese su clave de usuario autorizada"
                               class="form-field w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400">
                        <button type="button" id="validateKeyButton" 
                                class="px-4 py-2 bg-[#ff9e3d] text-white font-semibold rounded-md shadow-sm hover:bg-[#e08c34] transition-all duration-200">
                            Validar
                        </button>
                    </div>
                    <p id="keyMessage" class="text-sm font-semibold mt-2 h-5"></p>
                </div>

                <!-- fieldset (v15 - Cuerpo del formulario, deshabilitado por defecto) -->
                <fieldset id="formBody" disabled class="space-y-4 mt-4">
                    
                    <!-- 1. Proyecto -->
                    <div>
                        <label for="proyecto" class="block text-sm font-medium text-gray-700 mb-1">1. Proyecto</label>
                        <input type="text" id="proyecto" value="HIO" readonly
                               class="form-field w-full px-3 py-2 bg-gray-200 text-gray-500 border border-gray-300 rounded-md focus:outline-none">
                    </div>

                    <!-- 2. Originador -->
                    <div>
                        <label for="originador" class="block text-sm font-medium text-gray-700 mb-1">2. Originador</label>
                        <select id="originador" class="form-field form-select w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-500">
                            <option value="" selected disabled>Seleccione un Originador...</option>
                            <option value="SUP">SUP - Supervisión (AA - Proes Marconi Souto)</option>
                            <option value="CON">CON - Contratista (EROBO)</option>
                            <option value="FIO">FIO - FIO - Fiscal de Obra (UPRE)</option>
                            <option value="FIS">FIS - Fiscal de Seguimiento (GAMO)</option>
                        </select>
                    </div>

                    <!-- 3. Disciplina -->
                    <div>
                        <label for="disciplina" class="block text-sm font-medium text-gray-700 mb-1">3. Disciplina</label>
                        <select id="disciplina" class="form-field form-select w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-500">
                            <option value="" selected disabled>Seleccione una Disciplina...</option>
                            <option value="GER">GER - Gerencia de Supervisión</option>
                            <option value="ARQ">ARQ - Arquitectura</option>
                            <option value="EST">EST - Estructuras</option>
                            <option value="ELT">ELT - Eléctrica</option>
                            <option value="HID">HID - Hidrosanitario</option>
                            <option value="GMD">GMD - Gases Medicinales</option>
                            <option value="HVC">HVC - Climatización</option>
                            <option value="COM">COM - Datos y Comunicaciones</option>
                            <option value="BIO">BIO - Biomédico</option>
                            <option value="GNA">GNA - Gas Natural</option>
                            <option value="SSO">SSO - Seguridad y Salud Ocupacional</option>
                            <option value="MED">MED - Medio Ambiente</option>
                            <option value="GCC">GCC - Gestión / Coordinación / Control</option>
                        </select>
                    </div>

                    <!-- 4. Tipo de Documento -->
                    <div>
                        <label for="tipo" class="block text-sm font-medium text-gray-700 mb-1">4. Tipo de Documento</label>
                        <select id="tipo" class="form-field form-select w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-500">
                            <option value="" selected disabled>Seleccione un Tipo de Documento...</option>
                            <option value="M3D">M3D - Modelo 3D (rvt, ifc, nwd...)</option>
                            <option value="M2D">M2D - Plano 2D (dwg, pdf...)</option>
                            <option value="COM">COM - Cómputo Métrico (xls, pdf...)</option>
                            <option value="INF">INF - Informe (doc, pdf...)</option>
                            <option value="NOT">NOT - Nota (doc, pdf...)</option>
                            <option value="ACT">ACT - Acta (doc, pdf...)</option>
                            <option value="ESP">ESP - Especificación Técnica (doc, pdf...)</option>
                            <option value="MEM">MEM - Memoria de Cálculo (doc, pdf...)</option>
                            <option value="PRE">PRE - Presupuesto (xls, zpp...)</option>
                            <option value="CRN">CRN - Cronograma (mpp, pdf...)</option>
                            <option value="IMG">IMG - Imagen / Fotografía (png, pdf...)</option>
                        </select>
                    </div>

                    <!-- 5. Número Secuencial -->
                    <div>
                        <label for="numero" class="block text-sm font-medium text-gray-700 mb-1">5. Número Secuencial</label>
                        <input type="number" id="numero" placeholder="Ej: 6" min="1"
                               class="form-field w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400">
                        <p class="mt-1 text-xs text-gray-500">
                            ID único del archivo (ej. 0006). Consulte el Google Sheet para el siguiente número disponible.
                        </p>
                    </div>

                    <!-- 6. Revisión -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">6. Revisión</label>
                        <div class="flex gap-4">
                            <!-- Tipo de Revisión -->
                            <select id="revisionTipo" class="form-field form-select w-2/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-500">
                                <option value="" selected disabled>Seleccione un Tipo de Revisión...</option>
                                <option value="VP">VP - Versión Preliminar</option>
                                <option value="VC">VC - Versión para Construcción</option>
                                <option value="AB">AB - As-Built</option>
                            </select>
                            <!-- Número de Revisión -->
                            <input type="number" id="revisionNumero" placeholder="Ej: 1" min="1"
                                   class="form-field w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400">
                        </div>
                    </div>

                    <!-- 7. Fecha -->
                    <div>
                        <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">7. Fecha</label>
                        <input type="date" id="fecha"
                               class="form-field w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-500">
                    </div>

                    <!-- Subespecialidad (Opcional) -->
                    <div class="pt-2">
                        <label for="subespecialidad" class="block text-sm font-medium text-gray-700 mb-1">
                            Subespecialidad (Opcional)
                        </label>
                        <input type="text" id="subespecialidad" 
                               placeholder="Ej: Iluminación, Puesta a Tierra, Cimentaciones..."
                               class="form-field w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400">
                        <p class="mt-1 text-xs text-gray-500">
                            Detalle opcional para el registro. No forma parte del nombre del archivo.
                        </p>
                    </div>
                </fieldset>
                
                <!-- Separador (v15 - Sin títulos) -->
                <div class="border-t border-gray-200 pt-5 space-y-3 mt-4">
                    <!-- Vista Previa del Nombre -->
                    <div>
                        <label for="resultado" class="block text-sm font-medium text-gray-700 mb-1">Vista Previa del Nombre de Archivo (ID)</label>
                        <input type="text" id="resultado" readonly
                               class="w-full px-3 py-3 bg-gray-100 text-gray-500 border border-gray-300 rounded-md focus:outline-none text-lg font-mono tracking-wide">
                        <p id="copyMessage" class="text-sm text-green-600 font-semibold mt-2 h-5 opacity-0 transition-opacity duration-300">¡Nombre copiado al portapapeles!</p>
                    </div>
                    
                    <!-- Botón de Copiar Nombre (ID) -->
                    <button type="button" id="copyButton"
                            class="w-full flex justify-center items-center gap-2 px-4 py-3 bg-gray-300 text-white font-semibold rounded-md shadow-md transition-all duration-200 ease-in-out cursor-not-allowed"
                            disabled>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M7 2a2 2 0 00-2 2v12a2 2 0 002 2h6a2 2 0 002-2V4a2 2 0 00-2-2H7z"></path><path d="M10.5 1.5a1.5 1.5 0 00-3 0V3h3V1.5z"></path></svg>
                        Copiar Nombre de Archivo
                    </button>
                    
                    <!-- Botón de Registrar -->
                    <p class="text-xs text-gray-500 mt-4 mb-2">Paso final: Guarde este nombre en el registro centralizado.</p>
                    
                    <button type="button" id="registerButton"
                            class="w-full flex justify-center items-center gap-3 px-4 py-3 bg-orange-200 text-white font-bold rounded-md shadow-md transition-all duration-200 ease-in-out cursor-not-allowed"
                            disabled>
                        <!-- Spinner de carga, oculto por defecto -->
                        <div id="loadingSpinner" class="spinner w-5 h-5 border-4 border-t-4 border-white rounded-full hidden"></div>
                        <span id="registerButtonText">Registrar en Google Sheet</span>
                    </button>
                    
                    <!-- Mensaje de estado del registro -->
                    <p id="registerMessage" class="text-sm text-center font-semibold mt-2 h-5"></p>

                    <!-- Botón de Limpiar -->
                    <button type="button" id="clearButton"
                            class="w-full flex justify-center items-center gap-2 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-md shadow-sm transition-all duration-200 ease-in-out hover:bg-gray-300 mt-3">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        Limpiar Formulario
                    </button>
                </div>

            </div>
        </form>

        <!-- Pie de página (v15) -->
        <p class="text-center text-xs text-gray-400 mt-8">
            Herramienta desarrollada por Zacarias Ortega para el Proyecto Hospital de 2do. Nivel Isaías - Oruro.
        </p>

    </div>

    <!-- Lógica de la Aplicación -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONEXIÓN AL BACK-END ---
            // ¡¡¡ASEGÚRESE DE PEGAR SU URL DE SCRIPT AQUÍ!!!
            const googleAppScriptURL = "https://script.google.com/macros/s/AKfycbxSjEUaROYSueif6pA4bJxnFlxdDF-21y9lG_qYu09J6KtK3WmWdS593plI6sgL_22X8w/exec";

            // --- ESTADO GLOBAL ---
            let nombreUsuarioValidado = null;

            // --- REFERENCIAS A ELEMENTOS ---
            const form = document.getElementById('namingForm');
            const formBody = document.getElementById('formBody');

            const inputs = {
                proyecto: document.getElementById('proyecto'),
                originador: document.getElementById('originador'),
                disciplina: document.getElementById('disciplina'),
                tipo: document.getElementById('tipo'),
                numero: document.getElementById('numero'),
                revisionTipo: document.getElementById('revisionTipo'),
                revisionNumero: document.getElementById('revisionNumero'),
                fecha: document.getElementById('fecha'),
                subespecialidad: document.getElementById('subespecialidad'),
            };

            const claveInput = document.getElementById('claveAcceso');
            const validateKeyButton = document.getElementById('validateKeyButton');
            const keyMessage = document.getElementById('keyMessage');

            const resultadoInput = document.getElementById('resultado');
            const copyButton = document.getElementById('copyButton');
            const copyMessage = document.getElementById('copyMessage');
            
            const registerButton = document.getElementById('registerButton');
            const registerButtonText = document.getElementById('registerButtonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const registerMessage = document.getElementById('registerMessage');
            const clearButton = document.getElementById('clearButton');

            // --- LÓGICA PRINCIPAL ---

            const isFormValid = () => {
                const numValid = inputs.numero.value && parseInt(inputs.numero.value, 10) > 0;
                const revNumValid = inputs.revisionNumero.value && parseInt(inputs.revisionNumero.value, 10) > 0;
                const fechaValid = inputs.fecha.value !== "";
                const allSelected = inputs.originador.value && inputs.disciplina.value && inputs.tipo.value && inputs.revisionTipo.value;
                return allSelected && numValid && fechaValid && revNumValid && (nombreUsuarioValidado != null);
            };

            const updateUI = () => {
                const numValue = inputs.numero.value;
                const numValid = numValue && parseInt(numValue, 10) > 0;
                const revNumValue = inputs.revisionNumero.value;
                const revNumValid = revNumValue && parseInt(revNumValue, 10) > 0;
                const fechaValue = inputs.fecha.value;
                const fechaFormateada = fechaValue ? fechaValue.replace(/-/g, '') : 'YYYYMMDD';

                const nombre = [
                    inputs.proyecto.value,
                    inputs.originador.value || '???',
                    inputs.disciplina.value || '???',
                    inputs.tipo.value || '???',
                    (numValid ? String(numValue).padStart(4, '0') : '0000'),
                    (inputs.revisionTipo.value || 'R?') + (revNumValid ? String(revNumValue).padStart(2, '0') : '??'),
                    fechaFormateada
                ].join('-'); 

                resultadoInput.value = nombre;
                
                const formIsValid = isFormValid();

                if (formIsValid) {
                    copyButton.disabled = false;
                    copyButton.classList.remove('bg-gray-300', 'cursor-not-allowed');
                    copyButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    registerButton.disabled = false;
                    registerButton.classList.remove('bg-orange-200', 'cursor-not-allowed');
                    registerButton.classList.add('bg-[#ff9e3d]', 'hover:bg-[#e08c34]'); 
                    resultadoInput.classList.remove('text-gray-500', 'bg-gray-100');
                    resultadoInput.classList.add('text-black', 'bg-green-50');
                } else {
                    copyButton.disabled = true;
                    copyButton.classList.add('bg-gray-300', 'cursor-not-allowed');
                    copyButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                    registerButton.disabled = true;
                    registerButton.classList.add('bg-orange-200', 'cursor-not-allowed');
                    registerButton.classList.remove('bg-[#ff9e3d]', 'hover:bg-[#e08c34]'); 
                    resultadoInput.classList.add('text-gray-500', 'bg-gray-100');
                    resultadoInput.classList.remove('text-black', 'bg-green-50');
                }
            };

            // --- ACCIONES DE BOTONES ---

            /**
             * v18: Valida la clave usando POST y 'text/plain'
             */
            const handleKeyValidation = async () => {
                const clave = claveInput.value.trim();
                if (!clave) {
                    keyMessage.innerText = "Por favor, ingrese una clave.";
                    keyMessage.className = "text-sm font-semibold mt-2 h-5 text-red-600";
                    return;
                }

                validateKeyButton.disabled = true;
                validateKeyButton.innerText = "Validando...";
                keyMessage.innerText = "Validando clave...";
                keyMessage.className = "text-sm font-semibold mt-2 h-5 text-gray-500";
                
                try {
                    const response = await fetch(googleAppScriptURL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' }, 
                        body: JSON.stringify({
                            action: "validate", 
                            claveAcceso: clave
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Error de red: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.status === 'success') {
                        keyMessage.innerText = result.message; 
                        keyMessage.className = "text-sm font-semibold mt-2 h-5 text-green-600";
                        nombreUsuarioValidado = result.nombreUsuario; 
                        
                        formBody.disabled = false;
                        claveInput.disabled = true; 
                        validateKeyButton.innerText = "Validado";
                        validateKeyButton.classList.add("bg-green-600", "hover:bg-green-600", "cursor-not-allowed");
                        validateKeyButton.classList.remove("bg-[#ff9e3d]", "hover:bg-[#e08c34]");
                        
                    } else {
                        throw new Error(result.message);
                    }

                } catch (error) {
                    console.error('Error en validación:', error);
                    keyMessage.innerText = `Error: ${error.message || 'Failed to fetch'}`;
                    keyMessage.className = "text-sm font-semibold mt-2 h-5 text-red-600";
                    validateKeyButton.disabled = false;
                    validateKeyButton.innerText = "Validar";
                    nombreUsuarioValidado = null;
                }
            };
            
            validateKeyButton.addEventListener('click', handleKeyValidation);
            claveInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    handleKeyValidation();
                }
            });

            // 2. Lógica de COPIAR Nombre
            copyButton.addEventListener('click', () => {
                if (!isFormValid()) return;
                resultadoInput.select();
                resultadoInput.setSelectionRange(0, 99999);
                try {
                    document.execCommand('copy');
                    copyMessage.innerText = "¡Nombre copiado al portapapeles!";
                    copyMessage.classList.remove('opacity-0');
                    copyMessage.classList.add('opacity-100');
                    setTimeout(() => {
                        copyMessage.classList.remove('opacity-100');
                        copyMessage.classList.add('opacity-0');
                    }, 2000);
                } catch (err) {
                    console.error('Error al copiar: ', err);
                }
                window.getSelection().removeAllRanges();
            });

            /**
             * 3. Lógica de REGISTRO en Google Sheets
             * ¡SOLUCIÓN v22! "FIRE AND FORGET"
             * No usamos 'async/await' ni 'try/catch'
             * No esperamos la respuesta que causa el "cuelgue".
             */
            const registerData = () => {
                if (!isFormValid()) {
                     alert("Por favor, complete todos los campos obligatorios antes de registrar.");
                    return;
                }

                // 1. Mostrar estado de carga
                registerButton.disabled = true;
                registerButtonText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                registerMessage.innerText = `Registrando como ${nombreUsuarioValidado}...`;
                registerMessage.className = "text-sm text-center font-semibold mt-2 h-5 text-gray-500";

                // 2. Preparar los datos
                const nombreCompleto = resultadoInput.value;
                const revisionCompleta = (inputs.revisionTipo.options[inputs.revisionTipo.selectedIndex]?.text || "") + " " + String(inputs.revisionNumero.value).padStart(2, '0');
                
                const payload = {
                    nombreCompleto: nombreCompleto,
                    proyecto: inputs.proyecto.value,
                    originador: inputs.originador.options[inputs.originador.selectedIndex]?.text || "",
                    disciplina: inputs.disciplina.options[inputs.disciplina.selectedIndex]?.text || "",
                    tipo: inputs.tipo.options[inputs.tipo.selectedIndex]?.text || "",
                    numero: String(inputs.numero.value).padStart(4, '0'),
                    revision: revisionCompleta,
                    fecha: inputs.fecha.value,
                    subespecialidad: inputs.subespecialidad.value || "N/A",
                    nombreRegistrador: nombreUsuarioValidado 
                };

                // 3. "FIRE AND FORGET"
                // Enviamos los datos pero NO esperamos la respuesta.
                fetch(googleAppScriptURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: "register", 
                        payload: payload
                    })
                }).catch(err => {
                    // Aunque no esperamos, si hay un error de red *inmediato*
                    // (ej. sin internet), lo capturamos.
                    console.error('Error de red al registrar:', err);
                });
                
                // 4. ASUMIR ÉXITO Y LIMPIAR
                // Damos 2 segundos al script de Google para que trabaje (lo cual es mucho).
                setTimeout(() => {
                    registerMessage.innerText = "¡Registro enviado!";
                    registerMessage.className = "text-sm text-center font-semibold mt-2 h-5 text-green-600";
                    
                    // Limpiamos el formulario para el siguiente ingreso.
                    clearForm(false); // false = no limpiar la clave
                    
                    // Reactivamos el botón
                    registerButton.disabled = false;
                    registerButtonText.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    
                    // Ocultar el mensaje después de un rato
                    setTimeout(() => {
                         registerMessage.innerText = "";
                    }, 3000);

                }, 2000); // 2 segundos de espera
            };

            registerButton.addEventListener('click', registerData);

            /**
             * 4. Lógica de LIMPIAR FORMULARIO
             * (Arreglo v19)
             */
            const clearForm = (limpiarClave = true) => {
                
                // formBody.reset(); // <-- ¡ERROR v18!
                form.reset();      // <-- ¡CORRECCIÓN v19!
                
                if (limpiarClave) {
                    claveInput.value = "";
                    claveInput.disabled = false;
                    validateKeyButton.disabled = false;
                    validateKeyButton.innerText = "Validar";
                    validateKeyButton.classList.add("bg-[#ff9e3d]", "hover:bg-[#e08c34]");
                    validateKeyButton.classList.remove("bg-green-600", "hover:bg-green-600", "cursor-not-allowed");
                    keyMessage.innerText = "";
                    keyMessage.className = "text-sm font-semibold mt-2 h-5";
                    formBody.disabled = true; 
                    nombreUsuarioValidado = null;
                } else {
                    // Limpieza post-registro
                }
                
                Object.values(inputs).forEach(input => {
                    if (input.tagName === 'SELECT' || input.type === 'date') {
                        input.style.color = '#6b7280';
                    }
                });

                copyMessage.innerText = "";
                copyMessage.classList.add('opacity-0');
                registerMessage.innerText = "";
                registerMessage.className = "text-sm text-center font-semibold mt-2 h-5";

                updateUI();
            };

            clearButton.addEventListener('click', () => clearForm(true));

            // --- INICIALIZACIÓN ---
             Object.values(inputs).forEach(input => {
                if (input.tagName === 'SELECT' || input.type === 'date') {
                    input.style.color = '#6b7280'; 
                    input.addEventListener('change', () => {
                        if(input.value) {
                            input.style.color = '#000000';
                        }
                    });
                }
                
                input.addEventListener('change', updateUI);
                if (input.type === 'number' || input.type === 'text') {
                    input.addEventListener('keyup', updateUI);
                }
            });

            updateUI();
        });
    </script>
</body>
</html>
